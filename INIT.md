# Setup and start he project

This document describes how to setup the project and run it with Ganache network.

Main documentation can be found [here](https://docs.paimastudios.com/home/Setting%20Up%20Your%20Environment/how-to-use-paima-engine).

This document is a step-by-step guide for this particular project. 

Setup was tested with `paima-engine v0.6.0`.


Prerequisites:
- Setup builds with node `16.20.0`. Later versions may  fail. The easiest way I;ve found is to install Node via `nvm` and then `nvm use 16.20.0`.
- Setup requires `Metamask` wallet browser extension and EVM chain (does not use Paima `batcher`). [Ganache](https://trufflesuite.com/ganache/) is used in this guide as L1 EVM chain.

## Step 1 - prepare root dir
- Before you clone the repo, make some root directory for the project that will be the parent directory of the cloned repo (it will be referenced as `root` in the rest of the document).
- Copy `paima-engine` binary to `root`
- Clone repo to root

## Step 2 - initialization
- `cd` to `root`
- run `./paima-engine init sdk`
- cd to `example-game`
- (`nvm use 16.20.0` if needed) run `npm run initialize`. This will
  - install dependencies of `paima-sdk`
  - copies `.env.example` as `.env.development` to the parent folder
- run `npm run build`

If there are no errors, proceed further.

## Step 3 - check packing

`paima-engine` need game code and REST API to be packed before it can run the game. `middleware` also need to packed to `.js` file so frontend can use it.

### Pack game code
From `example-game` run 
```
npm run pack
```

You should see `packaged` directory in created in the `root`.

```
$ tree ../packaged/
  ../packaged/
  ├── endpoints.cjs
  ├── gameCode.cjs
  └── migrations
```

No compilation errors should appear.

### Pack `middleware`

To pack the `middleware`, first we need to add some contract address to `root/.env.development`, otherwise validation will fail and interrupt `middleware` packaging. 

Put some value into `CONTRACT_ADDRESS` key, e.g. `"0xA02F7744868945A346Ee6994068F54D039683445"` - we will change it later.

Then run 
```
npm run pack:middleware
```

You should see `paimaMiddleware.js` created in the `frontend` dir:

```
$ tree frontend/
frontend/
├── config.js
├── index.html
└── paimaMiddleware.js
```

No compilation errors should appear.

## Step 4 - deploy contracts

This guide uses [Ganache](https://trufflesuite.com/ganache/) as L1 blockchain.

One cumbersome thing with contracts, is that they are generated by `paima-engine` and require some edits before they can be deployed. But `example-game` directory contains already edited contracts and scripts, and copy-pasting them to correct location should just work. We will go through the process step by step. 

First of all, lets generate contracts. From `root` run

```
./paima-engine contracts
```
You should see `contracts` directory created in `root`:

```
$ tree -L 1 contracts
contracts
├── nft
└── paima-l2-contract

2 directories, 0 files
```

Now we can start deployment.

Before deploy, contract configs need to be adjusted. Most adjustments requires setting owner of the contract (which is public key hash of desired account). With Ganache, it is possible to create network with known keys by setting known seed phrase. There are examples of edited configs in [extra](./extra) with owner set to key derived from known seed. The seed is

```
link art cousin prosper kiss blast glimpse cricket guide arrive dune cinnamon
```

It will be referenced as `known seed` further.

So if you start Ganache network with this seed phrase and sue same `paima-engine` version, then files from `extra` directory just could be copied to corresponding locations inside `root/contracts` directory to overwrite existing ones. Files in `extra` directory also has Ganache network added to configs and deployment scripts, as files generated by `paima-engine` does not include Ganache network. But further explanation will cover in details what will need to be configured or adjusted in "default" files in `root/ contracts` directory.

Lets start with L2 contract deployment - it is not too involved and requires minimal configuration.

We will need hex representation of public and private keys for deploy.

### Deploying L2 game contract

- `cd` to `root/contracts/paima-l2-contract`
- (`nvm use 16.20.0` if needed) run `npm i`
- Edit `truffle-config.js` (if you are using Ganache with `known seed` and same `paima-engine` version, you can just copy over `truffle-config.js` from [extra/contracts/paima-l2-contract](./extra/contracts/paima-l2-contract/) dir and skip following subsections)
  - Set `owner` in `module.exports.contract_config.owner`. Set it to desired public key hex w/o `0x` prefix. With Ganache you can get key by clicking key icon in `ACCOUNTS` tab.
  - Add config for Ganache network to `module.exports.networks`, e.g. with default Ganache settings:
    ```
    ganache: {
      host: "localhost",
      port: 7545,
      network_id: "5777",
    },
    ```
- Set your private key hex to environment by `export PRIVATE_KEY=...` (w/o `0x` prefix)
- Run `npx truffle migrate --network ganache`. End of the successful report should look something like this:
  ```
  Summary
  =======
  > Total deployments:   1
  > Final cost:          0.002749953375 ETH
  ``````
- There is contract address in terminal output, like
  ```
  > contract address:    0x1ebe21e9B5ff8A1A97B95af8c7cB13C2E188837e
  ```
  Put it into `root/.env.development.CONTRACT_ADDRESS` key (with `0x` prefix) instead of the dummy one we put there earlier.

  (You can also find contract address in Ganache in `TRANSACTIONS` tab)
