<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <title>Test</title>
</head>

<body>
    <div>
        <p>Test2 </p>
        <div id="buttons"></div>
    </div>
    <div>
        <p>Results:</p>
        <div id="results"></div>
        
    </div>
</body>
<script src="./paimaMiddleware.js"></script>
<script>

    async function start() {
        console.log("Start");
        const wallet = await endpoints.userWalletLogin('metamask');
        if (!wallet.success) throw new Error('Wallet Error');



        // const user = await endpoints.getUserStats(wallet.result.walletAddress);
        // console.log(user)
        // if (!user.success) {
        //     throw new Error('User Error');
        // }
        // user.lol = "test lol";
        // console.log(user.lol)
        // if (!user.stats) {
        //     console.log(user.stats)
        // }

        const buttonsDiv = document.getElementById("buttons");
        const resultsDiv = document.getElementById("results");

        // submit button
        let submit = document.createElement("submit-button");
        // login.style = 'width:50px; margin: 4px;'
        submit.innerHTML = "Submit";
        submit.onclick = () => {
            endpoints.submitGuess(
                wallet.result.walletAddress,
                "DAB",
                "100+01+010"
            ).then(r => console.log("SubmitGuess", r));
        }
        buttonsDiv.appendChild(submit);

        // query test
        let query = document.createElement("query-button");
        // login.style = 'width:50px; margin: 4px;'
        query.innerHTML = "Query";
        query.onclick = () => {
            endpoints.getSubmissionIds(
                wallet.result.walletAddress
            ).then(r => console.log("Query submission", r));
        }
        buttonsDiv.appendChild(query);

        // run check 
        let check = document.createElement("query-button");
        // login.style = 'width:50px; margin: 4px;'
        check.innerHTML = "Check";
        check.onclick = () => {
            endpoints.getRoundExecutor(
                wallet.result.walletAddress,
                24
            ).then(res => processExecutor(res.result, resultsDiv)
            );
        }
        buttonsDiv.appendChild(check);
    }
    start().then(r => r);

    async function processExecutor(re, resultsDiv) {
        console.log("RE", re)
        // console.log("ES", re.endState())
        let eject = 0;
        let ticks = [];
        for (ticks = re.tick(); ticks != null; ticks = re.tick()) {
            let tick = ticks[0];
            console.log(tick);
            var p = document.createElement("p");
            p.innerHTML = tick.symbol + " as " + tick.code + " => " + (tick.isCorrect ? "Correct!" : "Wrong!");
            resultsDiv.appendChild(p);
            await new Promise(r => setTimeout(r, 1000));
            eject += 1;
            if (eject > 10) return;
        }
    }

</script>

</html>