<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <title>Test</title>
</head>

<body>
    <div>
        <h2>Previous submission IDs</h2>
        <label id="all-submission-ids"></label>
    </div>

    <div>
        <h2>My submission</h2>
        <input type="text" id="symbols" placeholder="symbols to guess">
        <input type="text" id="morze-code" placeholder="morze code, space separated">
        <button onclick="submitGuess()" id="submit-btn">Submit</button>
    </div>
    <div>
        <h2>Check result</h2>
        <input type="number" id="submission-id" placeholder="leave blank for latest">
        <button onclick="checkGuess()" id="check-btn">Check</button>
        <div id="check-result"></div>
    </div>
</body>
<script src="./paimaMiddleware.js"></script>
<script>

    let wallet;
    const submitBtn = document.getElementById("submit-btn");
    const submitSymbols = document.getElementById("symbols");
    const morzeCodeGuess = document.getElementById("morze-code");
    const submissionId = document.getElementById("submission-id");
    const checkBtn = document.getElementById("check-btn");
    const checkResult = document.getElementById("check-result");
    const allSubmissionIds = document.getElementById("all-submission-ids");

    async function submitGuess() {
        console.log(submitSymbols.value)
        endpoints.submitGuess(
            wallet.result.walletAddress,
            submitSymbols.value,
            morzeCodeGuess.value
        ).then(r => console.log("SubmitGuess", r));
    }

    async function checkGuess() {
        while (checkResult.firstChild) {
            checkResult.removeChild(checkResult.lastChild);
        }

        endpoints.getRoundExecutor(
            wallet.result.walletAddress,
            submissionId.value
        ).then(
            res => processExecutor(res.result)
        );
    }

    async function setup() {
        console.log("Start");
        wallet = await endpoints.userWalletLogin('metamask');

        if (!wallet.success) {
            submitBtn.disabled = true;
            checkBtn.disabled = true;
            throw new Error('Wallet Error');
        }

        const allSubmissions = await endpoints.getSubmissionIds(wallet.result.walletAddress);

        if (!allSubmissions.success) {
            console.error("Could not get submission IDs");
            alert("Could not get submission IDs");
        }

        allSubmissions.result.forEach(subId => {
            allSubmissionIds.innerHTML = allSubmissionIds.innerHTML + " " + subId.submission_id
        });
    }
    setup().then(r => r);

    async function processExecutor(roundEx) {
        console.log("Round Executor", roundEx)
        // console.log("ES", re.endState())
        let eject = 0;
        let ticks = [];
        for (ticks = roundEx.tick(); ticks != null; ticks = roundEx.tick()) {
            let tick = ticks[0];
            console.log(tick);
            var p = document.createElement("p");
            p.innerHTML = tick.symbol + " as " + tick.code + " => " + (tick.isCorrect ? "Correct!" : "Wrong!");
            checkResult.appendChild(p);
            await new Promise(r => setTimeout(r, 1000));
            eject += 1;
            if (eject > 10) return;
        }
    }

</script>

</html>