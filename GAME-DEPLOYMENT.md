# Setup and start he project

- [Setup and start he project](#setup-and-start-he-project)
  - [MacOS specific](#macos-specific)
  - [Demo](#demo)
  - [Step 1 - prepare root dir](#step-1---prepare-root-dir)
  - [Step 2 - initialization](#step-2---initialization)
  - [Step 3 - check packing](#step-3---check-packing)
    - [Pack game code](#pack-game-code)
    - [Pack `middleware`](#pack-middleware)
  - [Step 4 - deploy the game](#step-4---deploy-the-game)
    - [Deploying L2 game contract](#deploying-l2-game-contract)
    - [Deploy NFT contract](#deploy-nft-contract)
    - [Starting the game](#starting-the-game)
  - [Step 5 - The Game](#step-5---the-game)


This document describes how to set up the project and run it with the Ganache network.

Main Paima documentation can be found [here](https://docs.paimastudios.com/home/Setting%20Up%20Your%20Environment/how-to-use-paima-engine).

This document provides a step-by-step guide for a specific project. It differs from Paima templates in that it has many pre-configured settings for faster deployment with Ganache.

Setup was tested with `paima-engine v0.6.0`.

Prerequisites:
- Setup builds with node `16.20.0`. Later versions may  fail. The easiest way I've found is to install Node via `nvm` and then run `'nvm use 16.20.0'` where needed.
- Setup requires `Metamask` wallet browser extension and EVM chain (does not use Paima `batcher`). [Ganache](https://trufflesuite.com/ganache/) is used in this guide as L1 EVM chain.

## MacOS specific
This section is copied from the official Paima templates.

If you're using Mac and run into installation issues you can add `--target=esbuild-darwin-arm64` as a workaround to `npm install`. This installs the correct version of a problematic package. For example:

```
npm install --save-dev esbuild@latest --target=esbuild-darwin-arm64
```
## Demo
⚠️ There are a lot of things to grasp at once. To help with this, there is a demo of the deployment process available that uses some shortcuts with a deterministic Ganache setup: [link](https://drive.google.com/drive/folders/1D-xsbKTnuRLLybEywRO6_tYPytfiqDzr?usp=sharing).

## Step 1 - prepare root dir
- Before you clone the repo, make some root directory for the project that will be the parent directory of the cloned repo (it will be referenced as `root` in the rest of the document).
- Copy `paima-engine` binary to `root`
- Clone repo to root

## Step 2 - initialization
- `cd` to `root`
- Run `'./paima-engine init sdk'`. `paima-sdk` dir should appear in `root`.
- `cd` to `example-game`
- *(`nvm use 16.20.0` if needed)* run `'npm run initialize'`. This will
  - install dependencies of `paima-sdk`
  - copies `.env.example` as `.env.development` to the parent folder
- run `npm run build`

If there are no errors, proceed further.

## Step 3 - check packing

`paima-engine` requires game code and REST API to be packed before it can run the game. `middleware` also need to packed to `.js` file so frontend can use it.

### Pack game code
From `example-game` run 
```
npm run pack
```

You should see `packaged` directory being created in the `root`.

```
$ tree ../packaged/
  ../packaged/
  ├── endpoints.cjs
  ├── gameCode.cjs
  └── migrations
```

No compilation errors should appear.

### Pack `middleware`

From `example-game` run 
```
npm run pack:middleware
```

You should see `paimaMiddleware.js` created in the `frontend` dir:

```
$ tree frontend/
frontend/
├── config.js
├── index.html
└── paimaMiddleware.js
```

No compilation errors should appear.

> NOTE: official documentation starts from L2 contract deployment and only after that proceeds to `middleware` packing. The reason is that `.env.example` from official templates has a lot of fields empty (user need to fill them in), including address of the L2 contract. During packing, validation will detect those missing fields and will abort the process. To speedup deployment of this particular game with Ganache network, `.env.example` has everything filled in already, including L2 contract address, although it is not deployed yet. But if you going to use setup with `known seed` and Ganache (see below), the address will be always the same - `0x1ebe21e9B5ff8A1A97B95af8c7cB13C2E188837e`. If you deploying to different network, please read official documentation.

## Step 4 - deploy the game

This guide uses [Ganache](https://trufflesuite.com/ganache/) as L1 blockchain.

Before starting the game, the contracts need to be deployed. One issue with contracts is that they are generated by `paima-engine` and require editing before deployment. The `example-game` directory includes examples of edited contracts and scripts. In most cases, copying and pasting them to the correct location should work. We will go through the process step by step.

First of all, lets generate contracts. From `root` run

```
./paima-engine contracts
```
You should see `contracts` directory created in `root`:

```
$ tree -L 1 contracts
contracts
├── nft
└── paima-l2-contract

2 directories, 0 files
```

Now we can start deployment.

Before deploy, generated contract configs and some scripts need to be adjusted. Most adjustments require setting owner of the contract (which is the public key hash of desired account). With Ganache, it is possible to create network with known keys by setting known seed phrase. This way all account and contract address will be deterministic and can be known upfront. Current examples of edited contracts in [extra](./extra) directory have the "owner" set to the key derived from known seed phrase. The seed is

```
link art cousin prosper kiss blast glimpse cricket guide arrive dune cinnamon
```

It will be further referenced as `known seed`.

So if you start Ganache network with this seed phrase and use same `paima-engine` version (newer were not tested, but may work as well), then files from `extra` directory could be copied to corresponding locations inside the `root/contracts` directory to overwrite existing ones. Files in `extra` directory also has Ganache network added to configs and deployment scripts, as files generated by `paima-engine` does not include Ganache network. But further explanation will cover in details what need to be configured or adjusted in all required "default" files in `root/ contracts` directory.

Lets start with L2 contract deployment - it is not too involved and requires minimal configuration.

To deploy, we will need the hex representations of both the public and private keys. The same single key pair will be used for all contracts in this guide.

### Deploying L2 game contract

- Start Ganache and create new network. At startup window you can choose `"NEW WORKSPACE | ethereum"` option and in `"ACCOUNTS & KEYS"` tab specify `known seed`. This way the first key in the list of `ACCOUNTS` will be the one used in files for examples in [extra](./extra/) directory.
- `cd` to `root/contracts/paima-l2-contract`
- (`nvm use 16.20.0` if needed) run `npm i`
- Edit `truffle-config.js` (if you are using Ganache with `known seed` and same `paima-engine` version, you can just copy over `truffle-config.js` from [extra/contracts/paima-l2-contract](./extra/contracts/paima-l2-contract/) dir and skip following subsections)
  - Set `owner` in `module.exports.contract_config.owner`. Set it to desired public key hex w/o `0x` prefix. With Ganache you can get key by clicking "key icon" in `ACCOUNTS` tab.
  - Add config for Ganache network to `module.exports.networks`, e.g. with default Ganache settings:
    ```
    ganache: {
      host: "localhost",
      port: 7545,
      network_id: "5777",
    },
    ```
- Set your private key hex to the terminal environment: `export PRIVATE_KEY=...` (w/o `0x` prefix)
- Run `'npx truffle migrate --network ganache`. End of the successful report should look something like this:
  ```
  Summary
  =======
  > Total deployments:   1
  > Final cost:          0.002749953375 ETH
  ``````
- There should be contract address in the terminal output, like
  ```
  > contract address:    0x1ebe21e9B5ff8A1A97B95af8c7cB13C2E188837e
  ```
  Put it into `root/.env.development.CONTRACT_ADDRESS` key (with `0x` prefix) (with `known seed` setup it should be the same).

  (You can also find contract address in Ganache in `TRANSACTIONS` tab)

### Deploy NFT contract

This contract will alow minting of "stateful" NFT that will track player achievements.

- `cd` to `root`
- Copy `NftType.sol` and `NftTypeMapper.sol` from `example-game/extra/contracts/nft/src` to `contracts/nft/src` (you can check the diff before overwriting to see what was changed compared to default generated contracts)
- `cd` to `contracts/nft`
- *(if required run `nvm use 16.20.0`)* run `npm i`
- 3 files need to be edited here to enable current setup with Ganache (again, if you are using `known seed` and same version of `paima-engine`, it should be safe to overwrite those with files from [extra/contracts/nft](./extra/contracts/nft/) directory and skip to deployment)
  - Set owner and add Ganache network to `truffle-config.js`
  - Set owner in `deploy-config.json` file (at least for `ganache` network) - hex of pub key w/o `0x` prefix. See [example](./extra/contracts/nft/deploy-config.json) for reference. 
    
    It is not recommended to change anything else in `deploy-config.json` for the first time to see how game works ASAP. But if you change `Nft.name` attributes that defines the name for [CDE](https://docs.paimastudios.com/home/Reacting%20to%20Events/chain-data-extensions/), make sure that `ACHIEVEMENTS_CDE` constant in [achievements.ts](./utils/src/achievements.ts) has the same value.

  - Add option for deploying to Ganache to `deploy.sh`. Check the diff between current `deploy.sh` in `contracts/nft` and [example from extra](./extra/contracts/nft/deploy.sh) (or just copy or over if you see that adding ganache is the only difference there - could depend on `paima-engine` version probably).
- Deploy two contracts. Here we will need to deploy two contracts to Ganache network. 
  - Set hex of private key if it is not there yet (`export PRIVATE_KEY=...`, w/o `0x` prefix)
  - Run `./deploy.sh` and select option `3` for Ganache network
  - Select option `1` (Deployment functionality), then `1` again (The Nft contract (Paima ERC721)).
  - After process finish, follow the suggestion at the end of terminal output: in `root` create `extensions.yml` and under `extensions:` add suggested data. E.g.:
    ```
    extensions:
      - name: "Achievements NFT contract"
        type: erc721
        contractAddress: "0xe59c38D2cb89844283684E64C5E6aF988F381620"
        startBlockHeight: 3
        initializationPrefix: "nftmint"
    ```

  - Run `./deploy.sh` gain. Again select option `3` for Ganache, then option `1` for deploy, then `2` for "The NativeNftSale contract". After process is finished, put a note somewhere with "Deployed contract addresses" data.
  - Address of "NativeProxy" is required to configure `frontend`. Copy it and paste into [example-game/frontend/config.js](./frontend/config.js) as value for `achievementsProxyContract`.

Now, when all contracts are deployed, we can start the game.

Technically, it is possible to start the game w/o NFT contract, but achievements won't work.

### Starting the game

Prerequisites:
- Ganache is running and contracts are deployed
- Game code and middleware packed
- Docker is running - to start database container
- Browser with Metamask wallet extension configured to connect to Ganache. Wallet should have an account imported from one of the Ganache private keys

Now after contracts are deployed and game code and `middleware` packed, game can be launched.

Here we will need to start Docker container for database, start Paima engine and start frontend.

Follow this steps:
  - `cd` to `example-game`
  - Run `npm run database:up` and wait till DB is ready. Leave terminal running.
  - Open `root` in new terminal and execute `./paima-engine run`. Node should start syncing showing something like this:
    ```
    Starting Game Node...
    Using RPC: http://localhost:7545
    Targeting Smart Contact: 0x1ebe21e9B5ff8A1A97B95af8c7cB13C2E188837e
    [cde-config] config file not found: extensions.yml, assuming no CDEs.
    Game Node Webserver Started At: http://localhost:3333
    -------------------------------------
    Beginning Syncing & Processing Blocks
    -------------------------------------
    #2-4
    ```

  - In new terminal open `example-game` and run `npm run frontend`. Frontend will be served on port `8080`.

## Step 5 - The Game

The game is simple guess game: player submits some symbols (letters and digits without spaces), and their translation to Morze code (each code should be separated by space). E.g.:

- 1 <=> .----
- abc <=> .- -... -.-.
- test <=> - . ... -

After first launch, game should connect to the wallet (if it didn't happen, try to refresh page). Each user submission is single input for L2 contract that game node will process.

Under the hood, game `Round Executor` will compare symbol and code pairs in sequence one by one. Each comparison is one `tick`. User can check submissions in `Check result` section. Here `Round Executor` will be queried from the backend and simple animation will be played to show result of each `tick`.

`Activate achievements` wil mint "stateful" NFT and UI will start to show number of games played and longes win streak.
